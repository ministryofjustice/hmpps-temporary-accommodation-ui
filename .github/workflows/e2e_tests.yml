name: CAS3 UI E2E tests

on:
  workflow_call:

jobs:
  e2e_test:
    name: "CAS3 E2E Tests ðŸ§ª"
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shard: [ 1, 2, 3, 4 ]
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          # Repository is specified to run the workflow from the API repository
          repository: 'ministryofjustice/hmpps-temporary-accommodation-ui'

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit

      - name: Install Playwright
        run: npx playwright install chromium

      - name: Run E2E Tests
        env:
          ASSESSOR_USERNAME: ${secrets.E2E_USER_CAS3_ASSESSOR_USERNAME}
          ASSESSOR_PASSWORD: ${secrets.E2E_USER_CAS3_ASSESSOR_PASSWORD}
          REFERRER_USERNAME: ${secrets.E2E_USER_CAS3_REFERRER_USERNAME}
          REFERRER_PASSWORD: ${secrets.E2E_USER_CAS3_REFERRER_PASSWORD}
          ACTING_USER_PROBATION_REGION_ID: ${secrets.ACTING_USER_PROBATION_REGION_ID}
          ACTING_USER_PROBATION_REGION_NAME: ${ACTING_USER_PROBATION_REGION_NAME}
          ENVIRONMENT: 'dev'
          DEV_PLAYWRIGHT_BASE_URL: https://transitional-accommodation-dev.hmpps.service.justice.gov.uk
        run: npm run test:playwright:e2e:ci -- --shard=${{ matrix.shard }}/4

      - name: Upload Playwright report
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: E2E-playwright-report-${{ matrix.shard }}-of-4
          path: e2e_playwright/playwright-report
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload E2E artefacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: E2E-artefacts-${{ matrix.shard }}-of-4
          path: e2e_playwright/test-results
          retention-days: 30
          if-no-files-found: ignore
